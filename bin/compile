#!/usr/bin/env ruby

# sync output
$stdout.sync = true

$:.unshift File.expand_path("../../lib", __FILE__)
require "language_pack"

if pack = LanguagePack.detect(ARGV[0], ARGV[1])
  pack.log("compile") do
    pack.compile
  end
end

BUILD_DIR = ARGV[0]
CACHE_DIR = ARGV[1]

#Lineman stuff
require 'json'

class BuildLinemanApps
  include LanguagePack::ShellHelpers

  def build
    if File.exist?('lineman.json')
      p ARGV
      puts "Reading lineman.json configuration"
      config = JSON.parse(File.read('lineman.json'))
      puts "Config is: #{config}"
      puts "Installing Node"
      curl = "curl http://heroku-buildpack-nodejs.s3.amazonaws.com/nodejs-0.10.12.tgz -s -o - | tar xzf -"
      puts curl
      run(curl)
      npm_curl = "curl http://heroku-buildpack-nodejs.s3.amazonaws.com/npm-1.2.30.tgz -s -o - | tar xzf -"
      puts npm_curl
      run(npm_curl)
      p run(run_npm("--version"))
    else
      puts "no lineman.json configuration found"
    end
  end

  def run_npm command, home = BUILD_DIR
    "HOME=#{home} #{BUILD_DIR}/bin/node #{BUILD_DIR}/bin/npm-cli.js #{command}"
  end
end

BuildLinemanApps.new.build
